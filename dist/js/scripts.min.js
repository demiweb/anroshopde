// jQuery('#pewc_group_30224_30225, #pewc_group_29_12737,#pewc_group_29_12743,#pewc_group_29_12746,#pewc_group_29_12742,#pewc_group_29_11273,#pewc_group_29_12709,#pewc_group_29_12709,#pewc_group_29_111,#pewc_group_29_110,#pewc_group_29_94,#pewc_group_29_98,#pewc_group_29_99,#pewc_group_29_59,#pewc_group_29_118,#pewc_group_29_119,#pewc_group_29_118,#pewc_group_29_142,#pewc_group_29_118,#pewc_group_29_146,#pewc_group_29_118,#pewc_group_29_147').keyup(function () {
//     draw();
// });
//
// jQuery('.pewc-form-field,#pewc_group_29_60,#pewc_group_30224_30226,#pewc_group_30224_30227').keyup(function () {
//     draw();
// });
//
// jQuery('#pewc_group_29_59,#pewc_group_29_52,#pewc_group_73784_73785,#pewc_group_73784_73786').keyup(function () {
//     draw();
// });

let btnsCustomOrder = [...document.querySelectorAll('.canvasproduct--custom .single_add_to_cart_button')];

function generateImagePng() {

    if (btnsCustomOrder.length) {
        btnsCustomOrder.forEach((bt) => {
            let frmBt = bt.closest('form');
            frmBt.addEventListener("submit", async function () {
                console.log('Форма відправлена, чекаємо на успіх…');
                const canvas = document.querySelector('.svg-canvas-wrap canvas');
                const {jsPDF} = window.jspdf;

                const imgDataURL = canvas.toDataURL("image/png");
                const pngBlob = await (await fetch(imgDataURL)).blob();

                const pdf = new jsPDF({orientation: "landscape", unit: "mm", format: "a4"});
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
                const imgWidth = canvas.width * ratio;
                const imgHeight = canvas.height * ratio;
                const x = (pageWidth - imgWidth) / 2;
                const y = (pageHeight - imgHeight) / 2;

                pdf.addImage(imgDataURL, "PNG", x, y, imgWidth, imgHeight);
                const pdfBlob = pdf.output("blob");

                const randomString = Math.random().toString(36).substring(2, 10);
                const timestamp = Date.now();
                const fileBaseName = `canvas_${timestamp}_${randomString}`;

                const formData = new FormData();
                formData.append("image", pngBlob, `${fileBaseName}.png`);
                formData.append('pdf', pdfBlob, `${fileBaseName}.pdf`);

                fetch('/wp-json/customorder/v1/upload_pdf/', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            console.log('PDF uploaded:', data.url);
                        } else {
                            console.error('Upload error:', data);
                        }
                    });
            });
        })
    }
}
generateImagePng();

jQuery(document).on('input', 'input.pewc-number-field', function () {
    let val = $(this).val();
    if (val.includes('.')) {
        let parts = val.split('.');
        parts[1] = parts[1].slice(0, 1);
        jQuery(this).val(parts[0] + '.' + parts[1]);
    }
});
let figureWidth = 1;
let lengthFigures = 2;
if ([...document.querySelectorAll('.pewc-field-triggers-condition .pewc-radio-checkbox-image-wrapper')].length < 2) {
    document.querySelector('.pewc-field-triggers-condition').classList.add('hd-slt');
    lengthFigures = 1;
}
;
let imagesFarba = [...document.querySelectorAll('.pewc-item-radio:not(.pewc-field-triggers-condition)[data-field-label="Farbe"] .pewc-radio-checkbox-image-wrapper')];
console.log(imagesFarba);
console.log('farbas');
if (document.querySelector('.canvasproduct .woo-variation-gallery-slider-wrapper')) {
    let canvasDiv = document.createElement('div');
    canvasDiv.classList.add('svg-canvas-wrap');
    document.querySelector('.product-main__custom-slider').appendChild(canvasDiv);
}
let initedFarba = false;

function farbasControl() {
    // console.log('inited?');
    let saveFirstSlideImage = document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').src;
    let saveFirstSlideImageSrcSet = document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').srcset;

    let dotsBack = [...document.querySelectorAll('.product-main__canvas-slider .dots .single-dot')];


    if (dotsBack.length) {
        dotsBack.forEach((rb) => {
            rb.addEventListener('click', () => {
                [...document.querySelectorAll('.product-main__slider .swiper-slide img')][0].src = saveFirstSlideImage;
            })
        })
    }

    if (initedFarba === false) {
        if (imagesFarba.length) {


            imagesFarba.forEach((frb) => {
                let inp = frb.querySelector('input');
                let im = frb.querySelector('img').dataset.alt_image;
                // console.log('frabs +');
                inp.addEventListener('click', () => {
                    if (inp.checked === true) {
                        if (document.querySelector('.pewc-field-triggers-condition .pewc-radio-checkbox-image-wrapper').classList.contains('checked')) {
                        } else {
                            if (lengthFigures === 1) {
                                document.querySelector('.pewc-field-triggers-condition .pewc-radio-checkbox-image-wrapper label').click();
                            }
                        }
                        $('.woo-variation-gallery-slider').slick('slickGoTo', 0, false);
                        document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').src = im;
                        document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').srcset = im;
                        document.querySelector('.product-main__custom-slider').classList.remove('hd-sld');

                    }
                });

            });
            initedFarba = true;
        }
    }
    jQuery('.pewc-form-field').on('input', function () {

        jQuery('.product-main__custom-slider').addClass('hd-sld');
        if (document.querySelector('.pewc-field-triggers-condition .pewc-radio-checkbox-image-wrapper').classList.contains('checked')) {
        } else {
            if (lengthFigures === 1) {
                document.querySelector('.pewc-field-triggers-condition .pewc-radio-checkbox-image-wrapper label').click();
            }
        }
    });
    jQuery('.pewc-radio-images-wrapper.pewc-hide-labels .pewc-radio-image-wrapper label input').on('change', function () {

        jQuery('.product-main__custom-slider').addClass('hd-sld');

    });
    setTimeout(() => {
        jQuery('.woo-variation-gallery-thumbnail-wrapper img').each(function () {
            jQuery(this).on('click', function () {
                // console.log('clicked2tish');
                jQuery('.product-main__custom-slider').removeClass('hd-sld');
            });
        });
        let thumbsBack = [...document.querySelectorAll('.woo-variation-gallery-thumbnail-slider img')];
        if (thumbsBack.length) {
            // console.log('thumbs +');
            // console.log(thumbsBack);
            thumbsBack.forEach((rb) => {
                rb.addEventListener('click', () => {
                    document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').src = saveFirstSlideImage;
                    document.querySelector('.woo-variation-gallery-slider-wrapper .slick-slide[data-slick-index="0"] img').srcset = saveFirstSlideImageSrcSet;
                }, true);
            })
        }
    }, 2000);

}

function farbasImages2() {
    // if (imagesFarba.length) {
    console.log('farba +');
    if ($('.woo-variation-gallery-slider').hasClass('slick-initialized')) {
        console.log('inited3');
    }
    const waitForSlick = setInterval(() => {
        const $slider = $('.woo-variation-gallery-slider');
        if ($slider.hasClass('slick-initialized')) {
            clearInterval(waitForSlick);
            farbasControl();
            // console.log('ahada');
        } else {
            // console.log('');
        }
    }, 100);

    // }
}


jQuery('.pewc-form-field').on('input', function () {
    draw(this);
    jQuery('.product-main__custom-slider').addClass('hd-sld');
});
jQuery('.pewc-form-field').on('mouseenter', function () {
    draw(this);
});
jQuery('.pewc-form-field').on('mouseleave', function () {
    draw(false);
});
jQuery('.pewc-form-field').keyup(function () {
    draw(this);
    jQuery('.product-main__custom-slider').addClass('hd-sld');
});

const step = 20;


function get_field(name) {
    var labels = document.getElementsByTagName('h4');
    //console.log('find:',name);
    for (var i = 0; i < labels.length; i++) {
        //console.log(labels[i].textContent);
        if (labels[i].textContent.indexOf(name + ' in') !== -1) {
            console.log('Found:', name, jQuery(labels[i].nextSibling).val());
            id = '#' + jQuery(labels[i]).attr("for");
            console.log(id);
            return parseFloat(jQuery(id).val().replace(',', '.'));
            break;
        }
    }
}

let midArr1X = 0;
let midArr1Y = 0;

let midArr2X = 0;
let midArr2Y = 0;

let midArr3X = 0;
let midArr3Y = 0;

let midArr4X = 0;
let midArr4Y = 0;

function canvas_arrow(context, fromx, fromy, tox, toy, clrs) {
    // let canvas = document.getElementById('canvas');
    // let context = canvas.getContext('2d');
    context.beginPath(); // begin
    context.lineWidth = 1;

    console.log(clrs);
    console.log('colors input arrow');

    context.strokeStyle = '#000';


    var headlen = 10; // length of head in pixels
    var dx = tox - fromx;
    var dy = toy - fromy;
    var angle = Math.atan2(dy, dx);

    context.moveTo(fromx, fromy);
    context.lineTo(tox, toy);
    context.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
    context.moveTo(tox, toy);
    context.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
    context.moveTo(fromx, fromy);
    context.lineTo(fromx + headlen * Math.cos(angle - Math.PI / 6), fromy + headlen * Math.sin(angle - Math.PI / 6));
    context.moveTo(fromx, fromy);
    context.lineTo(fromx + headlen * Math.cos(angle + Math.PI / 6), fromy + headlen * Math.sin(angle + Math.PI / 6));


    context.closePath(); // close
    context.stroke();
}

function drawTtext(points) {
    var canvas = document.getElementById('canvas');

    console.log(points);

    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.beginPath(); // begin

        jQuery.each(points, function (index, value) {
            //if(index>0){
            if (value[3] === true) {

                ctx.fillStyle = '#5c9f3d';
                ctx.font = "bold 32px Arial";
            } else {
                ctx.fillStyle = '#000';
                ctx.font = "normal 24px Arial";
            }


            let textWidth = ctx.measureText(value[0]).width;
            let adjustedX = Number(value[1][0]);
            console.log(value[1][0] + ' va1 ' + (textWidth / 2) + ' text w' + ' var ' + value[0] + ' number ' + value[2]);

            if (value[2] === 2) {
                ctx.fillText(`${value[0]}`, (adjustedX - (ctx.measureText(value[0]).width / 2)), value[1][1] - 6);
            }
            if (value[2] === 1) {
                ctx.fillText(`${value[0]}`, (value[1][0] - ctx.measureText(value[0]).width - 16), value[1][1]);
            }
            if (value[2] === 3) {
                ctx.fillText(`${value[0]}`, (adjustedX - (ctx.measureText(value[0]).width / 2)), value[1][1] - 8);
            }
            if (value[2] === 4) {
                ctx.fillText(`${value[0]}`, (value[1][0] + 16), value[1][1]);
            }


            //ctx.rotate(value[1][2] * Math.PI / 180);
            //}

        });


        ctx.closePath(); // close
        ctx.strokeStyle = '#000'; // close
        ctx.stroke();
    }
}


function draw13(x, y, w, h, rad) {
    var canvas = document.getElementById('canvas');


    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');
        ctx.scale(1, 1);
        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();
        ctx.arc(x + rad, y + rad, rad, Math.PI, Math.PI + Math.PI / 2, false);
        ctx.lineTo(x + w - rad, y);
        ctx.arc(x + w - rad, y + rad, rad, Math.PI + Math.PI / 2, Math.PI * 2, false);
        ctx.lineTo(x + w, y + h);
        //ctx.arc(x + w - rad, y + h - rad, rad, Math.PI * 2, Math.PI / 2, false);
        ctx.lineTo(x, y + h);
        //ctx.arc(x + rad, y + h - rad, rad, Math.PI / 2, Math.PI, false);
        ctx.closePath(); // close
        ctx.stroke();
    }
}

function clipper(x, y, w, h, rad, points2, points3) {

    //x=x+20;
    var canvas = document.getElementById('canvas');

    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();
        ctx.lineWidth = figureWidth;
        //rad=rad*2;
        // ctx.strokeStyle = '#000';
        //ctx.fillStyle = '#A55D02';
        console.log('rad=' + rad + ' x+rad=' + (x + rad) + ' y+rad=' + (y + rad));
        ctx.arc(x + rad, y + rad, rad, Math.PI, Math.PI + Math.PI / 2, false);
        ctx.lineTo(x + w - rad, y);
        ctx.arc(x + w - rad, y + rad, rad, Math.PI + Math.PI / 2, Math.PI * 2, false);
        ctx.lineTo(x + w, y + h - rad);
        ctx.arc(x + w - rad, y + h - rad, rad, Math.PI * 2, Math.PI / 2, false);
        ctx.lineTo(x + rad, y + h);
        ctx.arc(x + rad, y + h - rad, rad, Math.PI / 2, Math.PI, false);
        ctx.lineTo(x, y + rad);
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();

        ctx.fillStyle = '#5c9f3d';
        ctx.closePath(); // close
        ctx.stroke();
        console.log(points2);
        console.log('input point20')
        canvas_arrow(ctx, points2[0][0] - step * 2, points2[0][1], points2[1][0] - step * 2, points2[1][1], points2[2]);

        midArr1X = ((points2[0][0] - step * 2) + (points2[1][0] - step * 2)) / 2;
        midArr1Y = ((points2[0][1]) + (points2[1][1])) / 2;

        canvas_arrow(ctx, points3[0][0], points3[0][1] + step * 2, points3[1][0], points3[1][1] + step * 2, points3[2]);
        console.log(points3);
        console.log('input point30')
        midArr2X = ((points3[0][0]) + (points3[1][0])) / 2;
        midArr2Y = ((points3[0][1] + step * 2) + (points3[1][1] + step * 2)) / 2;

        canvas_arrow(ctx, points2[0][0], points2[0][1] - step * 2, points2[0][0] + rad, points2[0][1] - step * 2, false);

        midArr3X = ((points2[0][0]) + (points2[0][0] + rad)) / 2;
        midArr3Y = ((points2[0][1] - step * 2) + (points2[0][1] - step * 2)) / 2;

        ctx.closePath(); // close
        ctx.stroke();
    }
}

function draw10(points, ww) {
    var canvas = document.getElementById('canvas');


    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');


        ctx.clearRect(0, 0, 1200, 1200);

        ctx.beginPath(); // begin


        ctx.moveTo(60, 60);
        ctx.lineTo(60, ww + 60);
        ctx.lineTo(ww + 60, ww + 60);
        ctx.moveTo(60, ww + 60);
        //ctx.moveTo(ww, ww);
        ctx.arc(60, ww + 60, ww, 1.5 * Math.PI, 0, false);


        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();
    }
}

function draw12(ww) {
    let canvas = document.getElementById('canvas');
    //const step=4;

    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');


        ctx.clearRect(0, 0, 1200, 1200);

        ctx.beginPath(); // begin


        //ctx.moveTo(160, 160);
        //ctx.lineTo(20, ww+20);
        ctx.lineWidth = figureWidth;
        ctx.arc(30 * step, 30 * step, ww / 2, 0 * Math.PI, 2 * Math.PI, false);
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();
        ctx.closePath(); // close
        ctx.stroke();
        ctx.fillStyle = '#5c9f3d';
        ctx.strokeStyle = '#000';

        canvas_arrow(ctx, 26 * step - ww / 2, 30 * step - ww / 2, 26 * step - ww / 2, 30 * step + ww / 2);
        midArr1X = ((26 * step - ww / 2) + (26 * step - ww / 2)) / 2;
        midArr1Y = ((30 * step - ww / 2) + (30 * step + ww / 2)) / 2;
        //canvas_arrow(ctx, points3[0][0], points3[0][1], points3[1][0], points3[1][1]);

        ctx.closePath(); // close
        ctx.stroke();
    }
}

function draw11(ww) {
    var canvas = document.getElementById('canvas');

    //const step=4;
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');


        ctx.clearRect(0, 0, 1200, 1200);

        ctx.beginPath(); // begin
        ctx.lineWidth = figureWidth;

        ctx.moveTo(30 * step - ww / 4, 30 * step - ww / 2);
        ctx.lineTo(30 * step - ww / 4, 30 * step + ww / 2);

        ctx.arc(30 * step - ww / 4, 30 * step, ww / 2, 1.5 * Math.PI, 0.5 * Math.PI, false);
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();

        ctx.fillStyle = '#5c9f3d';

        ctx.closePath(); // close
        ctx.stroke();
        ctx.strokeStyle = '#000';
        canvas_arrow(ctx, 26 * step - ww / 4, 30 * step - ww / 2, 26 * step - ww / 4, 30 * step + ww / 2);

        midArr1X = ((26 * step - ww / 4) + (26 * step - ww / 4)) / 2;
        midArr1Y = ((30 * step - ww / 2) + (30 * step + ww / 2)) / 2;

        canvas_arrow(ctx, 30 * step - ww / 4, 34 * step + ww / 2, 30 * step + ww / 4, 34 * step + ww / 2);

        midArr2X = ((30 * step - ww / 4) + (30 * step + ww / 4)) / 2;
        midArr2Y = ((34 * step + ww / 2) + (34 * step + ww / 2)) / 2;
        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();
    }
}

function drawHexagon(points, points2, points3) {
    var canvas = document.getElementById('canvas');
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');


        ctx.clearRect(0, 0, 1200, 1200);

        ctx.beginPath();
        ctx.moveTo(points[0][0], points[0][1]);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i][0], points[i][1]);
        }
        ctx.closePath();
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();
        ctx.fillStyle = '#5c9f3d';
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#000";
        ctx.stroke();

        canvas_arrow(ctx, points2[0][0] - step * 2, points2[0][1], points2[1][0] - step * 2, points2[1][1], points2[2]);
        midArr1X = ((points2[0][0] - step * 2) + (points2[1][0] - step * 2)) / 2;
        midArr1Y = ((points2[0][1]) + (points2[1][1])) / 2;

        canvas_arrow(ctx, points3[0][0], points3[0][1] + step * 2, points3[1][0], points3[1][1] + step * 2, points3[2]);

        midArr2X = ((points3[0][0]) + (points3[1][0])) / 2;
        midArr2Y = ((points3[0][1] + step * 2) + (points3[1][1] + step * 2)) / 2;

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();
    }

}

function drawOctagon(points, points2, points3, points4, points5) {
    var canvas = document.getElementById('canvas');
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();
        ctx.moveTo(points[0][0], points[0][1]);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i][0], points[i][1]);
        }
        ctx.closePath();
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();

        ctx.lineWidth = 3;
        ctx.strokeStyle = '#000';
        ctx.stroke();


        //     arrows

        canvas_arrow(ctx, points2[0][0] - step * 2, points2[0][1], points2[1][0] - step * 2, points2[1][1], points2[2]);
        midArr1X = ((points2[0][0] - step * 2) + (points2[1][0] - step * 2)) / 2;
        midArr1Y = ((points2[0][1]) + (points2[1][1])) / 2;

        canvas_arrow(ctx, points3[0][0], points3[0][1] + step * 2, points3[1][0], points3[1][1] + step * 2, points3[2]);

        midArr2X = ((points3[0][0]) + (points3[1][0])) / 2;
        midArr2Y = ((points3[0][1] + step * 2) + (points3[1][1] + step * 2)) / 2;

        canvas_arrow(ctx, points4[0][0], points4[0][1] - step * 2, points4[1][0], points4[1][1] - step * 2);

        midArr3X = ((points3[0][0]) + (points3[1][0])) / 2
        midArr3Y = ((points4[0][1] - step * 2.2) + (points4[1][1] - step * 2.2)) / 2;

        canvas_arrow(ctx, points5[0][0] + step * 2, points5[0][1], points5[1][0] + step * 2, points5[1][1], points5[2]);

        midArr4X = ((points5[0][0] + step * 2) + (points5[1][0] + step * 2)) / 2;
        midArr4Y = ((points5[0][1]) + (points5[1][1])) / 2;

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();

    }
}

function drawCapsule(points, points2, points3, points4, rad) {
    var canvas = document.getElementById('canvas');
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();
        ctx.moveTo(points[0][0], points[0][1]);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i][0], points[i][1]);
        }
        ctx.closePath();
        ctx.fillStyle = '#5c9f3d';
        ctx.fill();

        ctx.lineWidth = 3;
        ctx.strokeStyle = '#000';
        ctx.stroke();


        //     arrows

        canvas_arrow(ctx, points2[0][0] - step * 2, points2[0][1], points2[1][0] - step * 2, points2[1][1], points2[2]);
        midArr1X = ((points2[0][0] - step * 2) + (points2[1][0] - step * 2)) / 2;
        midArr1Y = ((points2[0][1]) + (points2[1][1])) / 2;
        canvas_arrow(ctx, points3[0][0], points3[0][1] + step * 2, points3[1][0], points3[1][1] + step * 2, points3[2]);

        midArr2X = ((points3[0][0]) + (points3[1][0])) / 2;
        midArr2Y = ((points3[0][1] + step * 2) + (points3[1][1] + step * 2)) / 2;

        canvas_arrow(ctx, points4[0][0], points4[0][1] - step * 2, points4[1][0], points4[1][1] - step * 2);

        midArr3X = ((points3[0][0]) + (points3[1][0])) / 2
        midArr3Y = ((points4[0][1] - step * 2.2) + (points4[1][1] - step * 2.2)) / 2;

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();

    }
}

function drawTetragon(points, points2, points3) {
    var canvas = document.getElementById('canvas');


    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');


        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath(); // begin
        ctx.lineWidth = figureWidth;
        ctx.moveTo(points[0][0], points[0][1]);
        jQuery.each(points, function (index, value) {
            if (index > 0) {
                ctx.lineTo(value[0], value[1]);
            }
        });

        ctx.lineTo(points[0][0], points[0][1]);

        ctx.fillStyle = '#5c9f3d';
        ctx.fill();
        ctx.fillStyle = '#5c9f3d';


        ctx.strokeStyle = '#000';
        ctx.closePath(); // close
        ctx.stroke();

        canvas_arrow(ctx, points2[0][0] - step * 2, points2[0][1], points2[1][0] - step * 2, points2[1][1], points2[2]);
        midArr1X = ((points2[0][0] - step * 2) + (points2[1][0] - step * 2)) / 2;
        midArr1Y = ((points2[0][1]) + (points2[1][1])) / 2;
        console.log(points3);
        console.log('points3 tetragon');
        canvas_arrow(ctx, points3[0][0], points3[0][1] + step * 2, points3[1][0], points3[1][1] + step * 2, points3[2]);

        midArr2X = ((points3[0][0]) + (points3[1][0])) / 2;
        midArr2Y = ((points3[0][1] + step * 2) + (points3[1][1] + step * 2)) / 2;

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();

    }
}

function drawEllipse(x, y, a, b) {
    var canvas = document.getElementById('canvas');
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);

        ctx.beginPath();
        ctx.lineWidth = figureWidth;
        ctx.ellipse(x, y, a, b, Math.PI / 1, 0, 2 * Math.PI);


        ctx.fillStyle = '#5c9f3d';
        ctx.fill();

        ctx.fillStyle = '#5c9f3d';

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();
        canvas_arrow(ctx, 26 * step - a, 30 * step - b, 26 * step - a, 30 * step + b);
        midArr1X = ((26 * step - a) + (26 * step - a)) / 2;
        midArr1Y = ((30 * step - b) + (30 * step + b)) / 2;

        canvas_arrow(ctx, 30 * step - a, 32 * step + b, 30 * step + a, 32 * step + b);

        midArr2X = ((30 * step - a) + (30 * step + a)) / 2;
        midArr2Y = ((32 * step + b) + (32 * step + b)) / 2;

        ctx.closePath(); // close
        ctx.stroke();
    }
}

function drawCircle(x, y, radius) {

    var canvas = document.getElementById('canvas');


    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, true);
        ctx.closePath(); // close
        ctx.stroke();
    }


}


function drawHalfCircle(x, y, radius) {

    var canvas = document.getElementById('canvas');


    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, 1200, 1200);
        ctx.beginPath();

        ctx.arc(x, y, radius, Math.PI, 0, true);


        ctx.closePath(); // close
        ctx.stroke();
    }


}


farbasImages2();


function draw(inp) {

    console.log('draw began');
    console.log(inp);
    //const step=4;
    const mw = step * 60;
    const mh = step * 60;
    if (!jQuery('#canvas').length) {
        console.log('create canvas');
        //jQuery('.woocommerce-product-gallery__wrapper').html('<canvas id="canvas" width="' + mw + '" height="' + mh + '"></canvas>');


        // const newNode = document.createElement("div");
        // newNode.setAttribute('width','20em');
        // newNode.innerHTML = '<canvas id="canvas" width="' + mw + '" height="' + mh + '"></canvas>';
        // const current = document.getElementsByClassName("pewc-product-extra-groups-wrap")[0];
        // const parentDiv = current.parentNode;
        // parentDiv.insertBefore(newNode, current);

        //jQuery('.delivery-time-info').html('<canvas id="canvas" width="' + mw + '" height="' + mh + '"></canvas>');

        jQuery('.product-main__custom-slider').addClass('hd-sld');
        jQuery('.product-main__custom-slider .svg-canvas-wrap').html('<canvas id="canvas" width="' + mw + '" height="' + mh + '"></canvas>');
        jQuery('.product-main__custom-slider .svg-canvas-wrap').html('<canvas id="canvas" width="' + mw + '" height="' + mh + '"></canvas>');


    }
    xx = step * 6;
    yy = step * 6;


    dots = Array();
    dots1 = Array();
    dots2 = Array();
    dots3 = Array();
    dots4 = Array();
    text = Array();

    let rindex = -1;
    console.log('size:', jQuery('.pewc-group-image_swatch .pewc-radio-form-field').length);
    if (jQuery('.pewc-group .pewc-radio-form-field').length == 1) {
        // rindex = 3;
    } else {
        jQuery('.pewc-group-image_swatch .pewc-hide-labels .pewc-radio-form-field').each(function (index) {
            if (jQuery(this).is(':checked')) {
                rindex = index + 1;

                const wrapper = jQuery(this).closest('.pewc-radio-checkbox-image-wrapper');
                const img = wrapper.find('img');

                if (img.length > 0) {
                    const src = img.attr('src');
                    if (src.includes('figure-rechteck')) {
                        if (!src.includes('figure-rechteckecken')) {
                            rindex = 1;
                            document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                            document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                        }
                    }
                    if (src.includes('figure-rund')) {
                        rindex = 2;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-rechteckecken')) {
                        rindex = 3;
                    }
                    if (src.includes('figure-ellipse')) {
                        rindex = 4;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-halbkreis')) {
                        rindex = 5;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-oval')) {
                        rindex = 6;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-sechseck')) {
                        rindex = 7;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-mittelstueck')) {
                        rindex = 8;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-bootsform2')) {
                        rindex = 8;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-bootsformq')) {
                        rindex = 8;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-achteck')) {
                        rindex = 9;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                    if (src.includes('figure-bootsform1')) {
                        rindex = 10;
                        document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
                        document.querySelector('.single_add_to_cart_button').style.opacity = '1';
                    }
                }

                return false;
            }
            if (rindex > 0) return false;
        });
    }
    //if(rindex>-1)alert(rindex);
    console.log('rindex:', rindex);
    console.log("selected index: " + jQuery('.pewc-radio-form-field:checked').val());
    if (rindex == 10) {
        var cc;
        hh = get_field('Height2');
        ww = get_field('Width2');
        cc = get_field('InnerWidth');
        dd = get_field('InnerHeight');

        let padding = 20;
        rww = ww;
        rhh = hh;
        rcc = cc;
        rdd = dd;

        let r = Math.max(
            ww / (mw - step * 10),
            hh / (mh - step * 10),
            1
        );
        ww /= r;
        hh /= r;
        cc /= r;
        dd /= r;

        const targetW = (mw - padding) * 0.6;
        const targetH = (mh - padding) * 0.6;
        const up = Math.min(targetW / ww, targetH / hh);
        if (up > 1) {
            ww *= up;
            hh *= up;
            cc *= up;
            dd *= up;
        }
        if (cc > ww) {
            text.push(Array('Fehler. Die Gesamtbreite muss größer als die Innenbreite sein.', [mw / 2, mh / 2], 2));
            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 26px Arial";
                return;
            }

        }
        if (dd > hh) {
            text.push(Array('Fehler. Die Gesamthöhe muss größer als die Innenhöhe sein', [mw / 2, mh / 2], 2));
            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 26px Arial";
                return;
            }
        }


        const cx=mw/2, cy=mh/2;
        const halfW=ww/2, halfH=hh/2;
        const halfCC=cc/2, halfDD=dd/2;

        // Ключові точки
        const B1=[cx-halfCC, cy-halfDD];
        const B2=[cx+halfCC, cy-halfDD];
        const D1=[cx+halfCC, cy+halfDD];
        const D2=[cx-halfCC, cy+halfDD];
        const A =[cx, cy-halfH];
        const C =[cx, cy+halfH];
        const W2=[cx+halfCC, cy];
        const W1=[cx-halfCC, cy];


        const cpTopX=2*A[0]-(B1[0]+B2[0])/2;
        const cpTopY=2*A[1]-(B1[1]+B2[1])/2;
        const cpRightX=W2[0], cpRightY=W2[1];
        const cpBotX=2*C[0]-(D1[0]+D2[0])/2;
        const cpBotY=2*C[1]-(D1[1]+D2[1])/2;
        const cpLeftX=W1[0], cpLeftY=W1[1];

        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 1200, 1200);
        const steps = 60;
        ctx.beginPath();
        ctx.beginPath();
        ctx.moveTo(...B1);
        ctx.quadraticCurveTo(cpTopX,   cpTopY,   ...B2);


        const rxR = halfW - halfCC;
        const ryR = halfDD;
        for (let i = 0; i <= steps; i++) {
            const ang = -Math.PI/2 + Math.PI * (i / steps);
            const xR = W2[0] + rxR * Math.cos(ang);
            const yR = W2[1] + ryR * Math.sin(ang);
            if (i === 0) ctx.lineTo(...B2);
            ctx.lineTo(xR, yR);
        }
        ctx.quadraticCurveTo(cpBotX,   cpBotY,   ...D2);
        for (let i = 0; i <= steps; i++) {
            const ang = Math.PI/2 + Math.PI * (i / steps);
            const xR = W1[0] + rxR * Math.cos(ang);
            const yR = W1[1] + ryR * Math.sin(ang);
            if (i === 0) ctx.lineTo(...D2);
            ctx.lineTo(xR, yR);
        }
        ctx.closePath();
        ctx.fillStyle='#5c9f3d'; ctx.fill();
        ctx.lineWidth=3; ctx.strokeStyle='#000'; ctx.stroke();

        l1 = ww / 2;

        lr = rww / l1;




        const hx = (ww - cc) / 2;
        const hy = (hh - dd) / 2;
        const yTop = cy - hh / 2;
        const yBot = cy + hh / 2;
        const xLeft = cx - cc / 2;
        const xRight = cx + cc / 2;
        const offsetX = (mw - ww) / 2;
        const offsetY = (mh - hh) / 2;

        dots1.push(Array(offsetX - step, offsetY));
        dots1.push(Array(offsetX - step, offsetY + hh));
        dots1.push(false);

        dots2.push(Array(offsetX, offsetY + hh + step));
        dots2.push(Array(offsetX + ww, offsetY + hh + step));
        dots2.push(false);

        dots3.push(Array(xLeft, yTop));
        dots3.push(Array(xLeft + cc, yTop));
        dots3.push(false);

        dots4.push(Array(cx + cc / 2 + hx, cy + hh / 2 - hy));
        dots4.push(Array(cx + cc / 2 + hx, cy - hh / 2 + hy));
        dots4.push(false);


        //     arrows

        canvas_arrow(ctx, dots1[0][0] - step * 2, dots1[0][1], dots1[1][0] - step * 2, dots1[1][1], dots1[2]);
        midArr1X = ((dots1[0][0] - step * 2) + (dots1[1][0] - step * 2)) / 2;
        midArr1Y = ((dots1[0][1]) + (dots1[1][1])) / 2;

        canvas_arrow(ctx, dots2[0][0], dots2[0][1] + step * 2, dots2[1][0], dots2[1][1] + step * 2, dots2[2]);

        midArr2X = ((dots2[0][0]) + (dots2[1][0])) / 2;
        midArr2Y = ((dots2[0][1] + step * 2) + (dots2[1][1] + step * 2)) / 2;

        canvas_arrow(ctx, dots3[0][0], dots3[0][1] - step * 2, dots3[1][0], dots3[1][1] - step * 2);

        midArr3X = ((dots2[0][0]) + (dots2[1][0])) / 2
        midArr3Y = ((dots3[0][1] - step * 2.2) + (dots3[1][1] - step * 2.2)) / 2;

        canvas_arrow(ctx, dots4[0][0] + step * 2, dots4[0][1], dots4[1][0] + step * 2, dots4[1][1], dots4[2]);

        midArr4X = ((dots4[0][0] + step * 2) + (dots4[1][0] + step * 2)) / 2;
        midArr4Y = ((dots4[0][1]) + (dots4[1][1])) / 2;

        ctx.closePath(); // close
        ctx.strokeStyle = '#000';
        ctx.stroke();


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Height2')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Width2')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('InnerWidth')) {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, true));
            } else {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
            }
        } else {
            text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('InnerHeight')) {
                text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, true));
            } else {
                text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, false));
            }
        } else {
            text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, false));
        }

        // text.push(Array('Länge in cm' + ' ' + rww + ' cm', [midArr3X, midArr3Y], 3));

        drawTtext(text);


    }
    if (rindex == 9) {
        dots1.length = dots2.length = dots3.length = dots4.length = 0;
        text.length = 0;
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 1200, 1200);
        var cc;
        let padding = 20;
        hh = get_field('Height2');
        ww = get_field('Width2');
        cc = get_field('InnerWidth');
        dd = get_field('InnerHeight');


        rww = ww;
        rhh = hh;
        rcc = cc;
        rdd = dd;

        const r = Math.max(
            ww / (mw - padding),
            hh / (mh - padding),
            1
        );
        ww /= r;
        hh /= r;
        cc /= r;
        dd /= r;

        const targetW = (mw - padding) * 0.6;
        const targetH = (mh - padding) * 0.6;
        const up = Math.min(targetW / ww, targetH / hh);
        if (up > 1) {
            ww *= up;
            hh *= up;
            cc *= up;
            dd *= up;
        }


        if (cc > ww) {
            text.push(Array('Fehler. Die Gesamtbreite muss größer als die Innenbreite sein.', [mw / 2, mh / 2], 2));
            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 26px Arial";
                return;
            }

        }
        if (dd > hh) {
            text.push(Array('Fehler. Die Gesamthöhe muss größer als die Innenhöhe sein', [mw / 2, mh / 2], 2));
            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 26px Arial";
                return;
            }
        }

        // Центр полотна
        const cx = mw / 2;
        const cy = mh / 2;

        // Зсуви для зрізаних кутів
        const hx = (ww - cc) / 2;   // горизонтальний зсув
        const hy = (hh - dd) / 2;   // вертикальний зсув

        const pts = [
            [cx - cc / 2, cy - hh / 2],                // 0: початок верхньої сторони (ліворуч)
            [cx + cc / 2, cy - hh / 2],                // 1: кінець верхньої сторони (праворуч)
            [cx + cc / 2 + hx, cy - hh / 2 + hy],      // 2: верхній правий зріз
            [cx + cc / 2 + hx, cy + hh / 2 - hy],      // 3: нижній правий зріз
            [cx + cc / 2, cy + hh / 2],                // 4: кінець нижньої сторони (праворуч)
            [cx - cc / 2, cy + hh / 2],                // 5: початок нижньої сторони (ліворуч)
            [cx - cc / 2 - hx, cy + hh / 2 - hy],      // 6: нижній лівий зріз
            [cx - cc / 2 - hx, cy - hh / 2 + hy]       // 7: верхній лівий зріз
        ];


        const yTop = cy - hh / 2;
        const yBot = cy + hh / 2;
        const xLeft = cx - cc / 2;
        const xRight = cx + cc / 2;
        const offsetX = (mw - ww) / 2;
        const offsetY = (mh - hh) / 2;

        //     arr + text

        l1 = ww / 2;

        lr = rww / l1;

        dots1.push(Array(offsetX - step, offsetY));
        dots1.push(Array(offsetX - step, offsetY + hh));
        dots1.push(false);

        dots2.push(Array(offsetX, offsetY + hh + step));
        dots2.push(Array(offsetX + ww, offsetY + hh + step));
        dots2.push(false);

        dots3.push(Array(xLeft, yTop));
        dots3.push(Array(xLeft + cc, yTop));
        dots3.push(false);

        dots4.push(Array(cx + cc / 2 + hx, cy + hh / 2 - hy));
        dots4.push(Array(cx + cc / 2 + hx, cy - hh / 2 + hy));
        dots4.push(false);

        drawOctagon(pts, dots1, dots2, dots3, dots4);


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Height2')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Width2')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('InnerWidth')) {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, true));
            } else {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
            }
        } else {
            text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('InnerHeight')) {
                text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, true));
            } else {
                text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, false));
            }
        } else {
            text.push(Array(rdd + ' cm', [midArr4X, midArr4Y], 4, false));
        }

        // text.push(Array('Länge in cm' + ' ' + rww + ' cm', [midArr3X, midArr3Y], 3));

        drawTtext(text);

    }
    if (rindex == 8) {
        var cc;
        hh = get_field('Height2');
        ww = get_field('Width2');
        cc = get_field('InnerWidthEllipse');

        let padding = 20;
        rww = ww;
        rhh = hh;
        rcc = cc;
        let r = Math.max(
            ww / (mw - step * 10),
            hh / (mh - step * 10),
            1
        );
        ww /= r;
        hh /= r;
        cc /= r;

        const targetW = (mw - padding) * 0.6;
        const targetH = (mh - padding) * 0.6;
        const up = Math.min(targetW / ww, targetH / hh);
        if (up > 1) {
            ww *= up;
            hh *= up;
            cc *= up;
        }



        const rx = ww / 2;
        if (cc / 2 > rx) {
            return;
        }
        const denom = 1 - (cc / 2) ** 2 / rx ** 2;
        if (denom <= 0) {
            return;
        }
        const ry = (hh / 2) / Math.sqrt(denom);


        const cx = mw / 2;
        const cy = mh / 2;

        const phi = Math.acos((cc / 2) / rx);

        const yTop = cy - hh / 2;
        const yBot = cy + hh / 2;
        const xLeft = cx - cc / 2;
        const xRight = cx + cc / 2;
        const offsetX = (mw - ww) / 2;
        const offsetY = (mh - hh) / 2;
        const pts = [];
        pts.push([xLeft, yTop], [xRight, yTop]);
        const steps = 30;
        for (let i = 0; i <= steps; i++) {
            const ang = -phi + (2 * phi * i / steps);
            pts.push([cx + rx * Math.cos(ang), cy + ry * Math.sin(ang)]);
        }
        pts.push([xLeft, yBot]);
        for (let i = 0; i <= steps; i++) {
            const ang = Math.PI - phi + (2 * phi * i / steps);
            pts.push([cx + rx * Math.cos(ang), cy + ry * Math.sin(ang)]);
        }

        l1 = ww / 2;

        lr = rww / l1;
        dots1.push(Array(offsetX - step, offsetY));
        dots1.push(Array(offsetX - step, offsetY + hh));
        dots1.push(false);

        dots2.push(Array(offsetX, offsetY + hh + step));
        dots2.push(Array(offsetX + ww, offsetY + hh + step));
        dots2.push(false);

        dots3.push(Array(xLeft, yTop));
        dots3.push(Array(xLeft + cc, yTop));
        dots3.push(false);

        drawCapsule(pts, dots1, dots2, dots3, (ww / lr) * 1);


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Height2')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Width2')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('InnerWidthEllipse')) {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, true));
            } else {
                text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
            }
        } else {
            text.push(Array(rcc + ' cm', [midArr3X, midArr3Y], 2, false));
        }

        // text.push(Array('Länge in cm' + ' ' + rww + ' cm', [midArr3X, midArr3Y], 3));

        drawTtext(text);


    }
    if (rindex == 7) {
        hh = get_field('Height2');
        ww = get_field('Width2');
        console.log(ww + ' wwwwww');
        console.log(hh + ' wwwwwhhhw');
        rww = ww;
        rhh = hh;
        const padding = 20;
        let r;
        if (ww > hh) {
            if (ww > mw) {
                r = ww / (mw - step * 10);
                ww = ww / r;
                hh = hh / r;
            } else {
                r = mw / ww;
                ww = ww * r - step * 10;
                hh = hh * r - step * 10;
            }
        } else {
            if (hh > mh) {
                r = hh / (mh - step * 10);
                ww = ww / r;
                hh = hh / r;
            } else {
                r = mh / hh;
                ww = ww * r;
                hh = hh * r - step * 10;
            }
        }
        ww *= 0.6;
        hh *= 0.6;
        const targetW = (mw - padding) * 0.6;
        const targetH = (mh - padding) * 0.6;
        const up = Math.min(targetW / ww, targetH / hh);
        if (up > 1) {
            ww *= up;
            hh *= up;

        }


        const offsetX = (mw - ww) / 2;
        const offsetY = (mh - hh) / 2;

        const halfWidth = ww / 2;
        const quarterWidth = ww / 4;
        const halfHeight = hh / 2;

        const pts = [
            [offsetX + quarterWidth, offsetY],
            [offsetX + quarterWidth + halfWidth, offsetY],
            [offsetX + ww, offsetY + halfHeight],
            [offsetX + quarterWidth + halfWidth, offsetY + hh],
            [offsetX + quarterWidth, offsetY + hh],
            [offsetX, offsetY + halfHeight]
        ];


        dots1.push(Array(offsetX - step, offsetY));
        dots1.push(Array(offsetX - step, offsetY + hh));
        if (inp !== false) {


            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Height2')) {
                dots1.push(true);
            } else {
                dots1.push(false);
            }
        } else {
            dots1.push(false);
        }
        dots2.push(Array(offsetX, offsetY + hh + step));
        dots2.push(Array(offsetX + ww, offsetY + hh + step));
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Width2')) {
                dots2.push(true);
            } else {
                dots2.push(false);
            }
        } else {
            dots2.push(false);
        }
        // drawTetragon(dots, dots1, dots2);
        drawHexagon(pts, dots1, dots2);
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Height2')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Width2')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }


        // text.push(Array('Länge in cm' + ' ' + rww + ' cm', [midArr3X, midArr3Y], 3));

        drawTtext(text);


    }

    if (rindex == 6) {


        //ww = parseFloat(jQuery('#pewc_group_29_59').val().replace(',', '.'));
        //hh = parseFloat(jQuery('#pewc_group_29_60').val().replace(',', '.'));
        ww = get_field('Breite');

        hh = get_field('Länge');

        if (ww > hh) {

            text.push(Array('Länge muss größer als Breite sein!', [150, 150]));
            text.push(Array('Bitte korrigieren Sie Ihre Eingabe!', [150, 200]));

            var canvas = document.getElementById('canvas');

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                drawTtext(text);
                ctx.font = "normal 24px Arial";
                return;
            }


        }
        l1 = ww / 2;

//        console.log(l1,ww/2);

        if (l1 > (ww / 2)) {

            //     l1=ww/2;
            //   jQuery('#pewc_group_29_11273').val(l1);

            text.push(Array('Radius muss max 1/2 von Breite sein!', [150, 150]));
            text.push(Array('Bitte korrigieren Sie Ihre Eingabe!', [150, 200]));

            var canvas = document.getElementById('canvas');

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, step * 60, step * 60);
                ctx.beginPath();
                drawTtext(text);
                ctx.font = "normal 24px Arial";
                return;
            }


        }

        rww = ww;
        rhh = hh;

        lr = rww / l1;

        if (ww > hh) {

            if (ww > mw) {


                r = ww / (mw - step * 10);
                ww = ww / r;
                hh = hh / r;
                //              l2=l1/r;
            } else {

                r = mw / (ww);
                ww = ww * r - step * 10;
                hh = hh * r - step * 10;
                //            l2=l1*r;
            }
        } else {
            if (hh > mh) {


                r = hh / (mh - step * 10);
                ww = ww / r;
                hh = hh / r;
//                l2=l1/r;
            } else {

                r = mh / (hh);
                ww = ww * r - step * 10;
                hh = hh * r - step * 10;
//                l2=l1*r;
            }
        }
        xx = mw / 2 - ww / 2;
        yy = mh / 2 - hh / 2;

        xx = xx + step * 4;

        dots1.push(Array(xx - step, yy));
        dots1.push(Array(xx - step, yy + hh));
        if (inp !== false) {


            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                dots1.push(true);
            } else {
                dots1.push(false);
            }
        } else {
            dots1.push(false);
        }

        dots2.push(Array(xx, yy + hh + step));
        dots2.push(Array(xx + ww, yy + hh + step));
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                dots2.push(true);
            } else {
                dots2.push(false);
            }
        } else {
            dots2.push(false);
        }

//        r=rww/l1;
//        l2=l1*r;

//        if ((l2*2)>ww)l2=ww;

        console.log('clipper', ww, lr);

        clipper(xx, yy + step, ww * 1, hh * 1, (ww / lr) * 1, dots1, dots2);


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }

        text.push(Array(l1 + ' cm', [midArr3X, midArr3Y], 3, false));

        // text.push(Array('Kante' + ' ' + l1 + ' cm', [xx + step*10, yy - step]));

        drawTtext(text);
    }

    if (rindex == 3) {
        hh = get_field('Länge');
        ww = get_field('Breite');//parseFloat(jQuery('#pewc_group_29_59').val().replace(',', '.'));
        // console.log(ww);

        //parseFloat(jQuery('#pewc_group_29_60').val().replace(',', '.'));

        // if (ww > hh) {
        if (ww > 10000) {

            text.push(Array('Länge muss größer als Breite sein!', [150, 150]));
            text.push(Array('Bitte korrigieren Sie Ihre Eingabe!', [150, 200]));

            var canvas = document.getElementById('canvas');

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 24px Arial";
                return;
            }


        }


        l1 = get_field('Radius');//parseFloat(jQuery('#pewc_group_29_11273').val().replace(',', '.'));
        // console.log(l1);
        if (!l1) l1 = 5;
//        console.log(l1,ww/2);

        if (l1 > (ww / 2) || l1 > (hh / 2)) {

            //     l1=ww/2;
            //   jQuery('#pewc_group_29_11273').val(l1);
            document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'none';
            document.querySelector('.single_add_to_cart_button').style.opacity = '0.3';
            text.push(Array('Radius muss max 1/2 von Breite sein!', [600, 550], 3));
            text.push(Array('Bitte korrigieren Sie Ihre Eingabe!', [600, 650], 3));

            var canvas = document.getElementById('canvas');

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.font = "normal 26px Arial";
                ctx.clearRect(0, 0, 1200, 1200);
                ctx.beginPath();
                ctx.lineWidth = figureWidth;
                drawTtext(text);
                ctx.font = "normal 24px Arial";
                return;
            }


        } else {
            document.querySelector('.single_add_to_cart_button').style.pointerEvents = 'auto';
            document.querySelector('.single_add_to_cart_button').style.opacity = '1';
        }

        rww = ww;
        rhh = hh;

        lr = rww / l1;

        if (ww > hh) {

            if (ww > mw) {


                r = ww / (mw - step * 10);
                ww = ww / r;
                hh = hh / r;
                //              l2=l1/r;
            } else {

                r = mw / (ww);
                ww = ww * r - step * 10;
                hh = hh * r - step * 10;
                //            l2=l1*r;
            }
        } else {
            // console.log(mh + ' mh');
            if (hh > mh) {


                r = hh / (mh - step * 10);
                ww = ww / r;
                hh = hh / r;
//                l2=l1/r;
            } else {
                // console.log('tut1');


                r = mh / hh;
                ww = ww * r;
                hh = (hh * r) - step * 10;
//                l2=l1*r;
            }
        }
        xx = step * 38 - ww / 2;
        yy = step * 30 - hh / 2;
        ww = ww * 0.8;
        // xx = xx + step * 4;

        dots1.push(Array(xx - step, yy));
        dots1.push(Array(xx - step, yy + hh));

        dots2.push(Array(xx, yy + hh + step));
        dots2.push(Array(xx + ww, yy + hh + step));

//        r=rww/l1;
//        l2=l1*r;

//        if ((l2*2)>ww)l2=ww;

        //console.log(lr);
        // console.log(ww + ' ww ' + lr + ' lr');
        clipper(xx, yy, ww * 1, hh * 1, (ww / lr) * 1, dots1, dots2);

        //text.push(Array(jQuery("label[for*=\'pewc_group_29_60\']").text() + ' ', [xx - step*7, yy + hh / 2]));


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Radius')) {
                text.push(Array(l1 + ' cm', [midArr3X, midArr3Y], 3, true));
            } else {
                text.push(Array(l1 + ' cm', [midArr3X, midArr3Y], 3, false));
            }
        } else {
            text.push(Array(l1 + ' cm', [midArr3X, midArr3Y], 3, false));
        }

        drawTtext(text);

    }

    if (rindex == 1) {

        hh = get_field('Länge');
        ww = get_field('Breite');
        console.log(ww + ' wwwwww');
        console.log(hh + ' wwwwwhhhw');
        rww = ww;
        rhh = hh;

        if (ww > hh) {

            if (ww > mw) {
                r = ww / (mw - step * 10);
                ww = ww / r;
                hh = hh / r;
            } else {
                r = mw / (ww);
                ww = ww * r - step * 10;
                hh = hh * r - step * 10;
            }
        } else {

            if (hh > mh) {
                r = hh / (mh - step * 10);
                ww = ww / r;
                hh = hh / r;
                // console.log('hh1:',hh);
            } else {
                console.log('trsas112');
                r = mh / hh;
                ww = ww * r;
                hh = (hh * r) - step * 10;
                // console.log('hh2:',hh);
            }
        }

        xx = step * 38 - ww / 2;
        yy = step * 30 - hh / 2;

        ww = ww * 0.8;

        dots.push(Array(xx, yy));
        dots.push(Array(xx + ww, yy));
        dots.push(Array(xx + ww, yy + hh));
        dots.push(Array(xx, yy + hh));


        dots1.push(Array(xx - step, yy));
        dots1.push(Array(xx - step, yy + hh));
        if (inp !== false) {


            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                dots1.push(true);
            } else {
                dots1.push(false);
            }
        } else {
            dots1.push(false);
        }
        dots2.push(Array(xx, yy + hh + step));
        dots2.push(Array(xx + ww, yy + hh + step));
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                dots2.push(true);
            } else {
                dots2.push(false);
            }
        } else {
            dots2.push(false);
        }
        drawTetragon(dots, dots1, dots2);

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }


        // text.push(Array('Länge in cm' + ' ' + rww + ' cm', [midArr3X, midArr3Y], 3));

        drawTtext(text);

    }

    if (rindex == 4) {

        ww = get_field('Breite');//parseFloat(jQuery('#pewc_group_29_59').val().replace(',', '.'));
        hh = get_field('Länge');//parseFloat(jQuery('#pewc_group_29_60').val().replace(',', '.'));

        rww = ww;
        rhh = hh;
        // console.log(ww, hh);
        if (ww > hh) {
            // console.log('ok');
            r = ww / hh;
            ww = step * 43;
            hh = step * 43 / r;

        } else {

            r = hh / ww;
            // console.log(r);
            hh = step * 43;
            ww = step * 43 / r;

        }

        // console.log(ww, hh);

        drawEllipse(step * 30, step * 30, ww / 2, hh / 2);


        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Länge')) {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rhh + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Breite')) {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr2X, midArr2Y], 2, false));
        }
        // text.push(Array(rhh + ' cm3', [midArr3X, midArr3Y], 3));

        drawTtext(text);

    }


    if (rindex == 5) {

        ww = get_field('Durchmesser');
        rw = ww;
        if (ww > mw) ww = mw - step * 10;
        ww = 40 * step;
        hh = ww / 2;


        draw11(ww);

        text.push(Array(rw * 2 + ' cm', [midArr1X, midArr1Y], 1, false));

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Durchmesser')) {
                text.push(Array(rw + ' cm', [midArr2X, midArr2Y], 2, true));
            } else {
                text.push(Array(rw + ' cm', [midArr2X, midArr2Y], 2, false));
            }
        } else {
            text.push(Array(rw + ' cm', [midArr2X, midArr2Y], 2, false));
        }
        // text.push(Array(rw / 2 + ' cm', [midArr3X, midArr3Y], 3));
        drawTtext(text);
    }

    if (rindex == 2) {

        ww = get_field('Durchmesser');//parseFloat(jQuery('#pewc_group_29_146').val().replace(',', '.'));
        console.log('Durchmesser is', ww);
        rww = ww;
        if (ww > mw) ww = mw - 20 * step;

        ww = 40 * step;


        draw12(ww);


        xx = mw / 2 - ww / 2;
        yy = xx;
        //console.log(xx-50,yy+ww/2);
        //text.push(Array(rww + ' cm', [xx - 10*step, 10 + yy + ww / 2]));

        if (inp !== false) {
            if (inp.closest('.pewc-item').getAttribute('data-field-label').includes('Durchmesser')) {
                text.push(Array(rww + ' cm', [midArr1X, midArr1Y], 1, true));
            } else {
                text.push(Array(rww + ' cm', [midArr1X, midArr1Y], 1, false));
            }
        } else {
            text.push(Array(rww + ' cm', [midArr1X, midArr1Y], 1, false));
        }
        drawTtext(text);

    }

}

window.addEventListener("load", (event) => {
    if (jQuery('#evdev_canvas')) {

        jQuery('body').on('click', '.pewc-field-triggers-condition .pewc-radio-image-wrapper', function (e) {
        }).on('click', '.pewc-field-triggers-condition .pewc-hide-labels .pewc-radio-image-wrapper .pewc-radio-form-field', function (e) {
            draw(false);
        });
        if (document.querySelector('.canvasproduct--custom')) {
            [...document.querySelectorAll('.pewc-field-triggers-condition .pewc-radio-image-wrapper')][0].click();
        }
    }
});